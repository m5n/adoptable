require 'json'
require 'open-uri'
require 'time'
require File.expand_path('../../lib/ad', __FILE__)
require File.expand_path('../../lib/job', __FILE__)

name = "AllPaws"

Adoptable::Job.new(name).run do |target_species, target_breeds, target_exclude_breeds, target_gender, target_age, target_zip, target_distance|
 all_ads = []

 target_breeds.each do |breed|
  # Convert settings to site-specific codes
  distance = target_distance * 1.60934

  species_id =
    # TODO: add all species
    case target_species.downcase
    when 'dog' then 1
    else raise "Unknown species: #{target_species}"
    end

  breed_id = 
    # TODO: add all breeds
    case breed.downcase
    when 'havanese' then 142
    when 'maltese' then 175
    when 'yorkie' then 289
    when 'yorkshire' then 289
    else raise "Unknown breed: #{breed}"
    end

=begin
<select class="breed-select dim-first form-control js-select-breed select-area show-menu-arrow show-tick type" data-live-search="true" data-size="10" name="breed_id" title="Select Breeds (Optional)" style="display: none;"><option value="">Select Breeds (Optional)</option><option value="1">Affenpinscher</option><option value="2">Afghan Hound</option><option value="3">Airedale Terrier</option><option value="4">Akbash</option><option value="5">Akita</option><option value="6">Alaskan Klee Kai</option><option value="7">Alaskan Malamute</option><option value="8">American Bulldog</option><option value="9">American Eskimo Dog</option><option value="10">American Foxhound</option><option value="11">American Hairless Terrier</option><option value="12">American Pit Bull Terrier</option><option value="13">American Staffordshire Terrier</option><option value="14">American Water Spaniel</option><option value="15">Anatolian Karabash Dog</option><option value="16">Anatolian Shepherd</option><option value="17">Appenzell Mountain Dog</option><option value="18">Argentinian Mastiff</option><option value="19">Australian Cattle Dog/Blue Heeler</option><option value="20">Australian Kelpie</option><option value="21">Australian Shepherd</option><option value="22">Australian Terrier</option><option value="23">Basenji</option><option value="24">Basset Griffon Vendeen</option><option value="25">Basset Hound</option><option value="26">Beagle</option><option value="27">Bearded Collie</option><option value="28">Beauceron</option><option value="29">Bedlington Terrier</option><option value="30">Belgian Griffon</option><option value="31">Belgian Shepherd Dog Sheepdog</option><option value="32">Belgian Shepherd Laekenois</option><option value="33">Belgian Shepherd Malinois</option><option value="34">Belgian Shepherd Tervuren</option><option value="35">Bernese Mountain Dog</option><option value="36">Bichon Frise</option><option value="37">Biewer</option><option value="38">Black and Tan Coonhound</option><option value="39">Black Labrador Retriever</option><option value="40">Black Mouth Cur</option><option value="41">Black Russian Terrier</option><option value="42">Bloodhound</option><option value="43">Blue Lacy</option><option value="44">Bluetick Coonhound</option><option value="45">Bobtail</option><option value="46">Boerboel Mastiff</option><option value="47">Bolognese</option><option value="48">Bordeaux</option><option value="49">Border Collie</option><option value="50">Border Terrier</option><option value="51">Borzoi</option><option value="52">Boston Terrier</option><option value="53">Bouvier des Flandres</option><option value="54">Boxer</option><option value="55">Boykin Spaniel</option><option value="56">Brazilian Mastiff</option><option value="57">Briard</option><option value="58">Brittany</option><option value="59">Brussels Griffon</option><option value="60">Bull Terrier</option><option value="61">Bulldog</option><option value="62">Bullmastiff</option><option value="63">Cairn Terrier</option><option value="64">Canaan Dog</option><option value="65">Cane Corso Mastiff</option><option value="66">Cardigan Welsh Corgi</option><option value="67">Carolina Dog</option><option value="68">Catahoula Leopard Dog</option><option value="69">Cattle Dog</option><option value="70">Caucasian Sheepdog (Caucasian Ovtcharka)</option><option value="71">Cavalier King Charles Spaniel</option><option value="72">Chesapeake Bay Retriever</option><option value="73">Chihuahua</option><option value="74">Chinese Crested-Hairless</option><option value="75">Chinese Crested-Powder Puff</option><option value="76">Chinese Foo Dog</option><option value="77">Chinese Shar-Pei</option><option value="78">Chinook</option><option value="79">Chocolate Labrador Retriever</option><option value="80">Chow Chow</option><option value="81">Cirneco dellEtna</option><option value="82">Clumber Spaniel</option><option value="83">Cockapoo</option><option value="84">Cocker Spaniel</option><option value="85">Collie</option><option value="86">Coonhound</option><option value="87">Corgi</option><option value="88">Coton de Tulear</option><option value="89">Curly-Coated Retriever</option><option value="90">Dachshund</option><option value="91">Dalmatian</option><option value="92">Dandie Dinmont Terrier</option><option value="93">Danish Broholmer</option><option value="94">Deerhound</option><option value="95">Doberman Pinscher</option><option value="96">Dogo Argentino</option><option value="97">Dogue de Bordeaux</option><option value="98">Dutch Shepherd</option><option value="99">Elkhound</option><option value="100">English Bulldog</option><option value="101">English Cocker Spaniel</option><option value="102">English Coonhound</option><option value="103">English Foxhound</option><option value="104">English Mastiff</option><option value="105">English Pointer</option><option value="106">English Setter</option><option value="107">English Sheepdog</option><option value="108">English Shepherd</option><option value="109">English Springer Spaniel</option><option value="110">English Toy Spaniel</option><option value="111">Entlebucher</option><option value="112">Eskimo Dog</option><option value="113">Eskimo Spitz</option><option value="114">Eurasier</option><option value="115">Feist</option><option value="116">Field Spaniel</option><option value="117">Fila Brasileiro</option><option value="118">Finnish Lapphund</option><option value="119">Finnish Spitz</option><option value="120">Flat-coated Retriever</option><option value="121">Fox Terrier</option><option value="122">Foxhound</option><option value="123">French Brittany</option><option value="124">French Bulldog</option><option value="125">French Mastiff</option><option value="126">Galgo Spanish Greyhound</option><option value="127">German Pinscher</option><option value="128">German Shepherd Dog</option><option value="129">German Shorthaired Pointer</option><option value="130">German Spitz</option><option value="131">German Wirehaired Pointer</option><option value="132">Giant Schnauzer</option><option value="133">Glen of Imaal Terrier</option><option value="134">Golden Retriever</option><option value="135">Gordon Setter</option><option value="136">Great Dane</option><option value="137">Great Pyrenees</option><option value="138">Greater Swiss Mountain Dog</option><option value="139">Greyhound</option><option value="140">Halden Hound (Haldenstrover)</option><option value="141">Harrier</option><option value="142">Havanese</option><option value="143">Hollandse Tulphond</option><option value="144">Hound</option><option value="145">Hovawart</option><option value="146">Husky</option><option value="147">Ibizan Hound</option><option value="148">Illyrian Sheepdog</option><option value="149">Irish Setter</option><option value="150">Irish Terrier</option><option value="151">Irish Water Spaniel</option><option value="152">Irish Wolfhound</option><option value="153">Italian Greyhound</option><option value="154">Italian Mastiff</option><option value="155">Italian Spinone</option><option value="156">Jack Russell Terrier</option><option value="157">Jack Russell Terrier (Parson Russell Terrier)</option><option value="158">Japanese Chin</option><option value="159">Jindo (Korean)</option><option value="160">Kai Dog</option><option value="161">Karelian Bear Dog</option><option value="162">Keeshond</option><option value="163">Kerry Blue Terrier</option><option value="164">Kishu</option><option value="165">Klee Kai</option><option value="166">Komondor</option><option value="167">Kuvasz</option><option value="168">Kyi Leo</option><option value="169">Labrador Retriever</option><option value="170">Lakeland Terrier</option><option value="171">Lancashire Heeler</option><option value="172">Leonberger</option><option value="173">Lhasa Apso</option><option value="174">LÃ¶wchen</option><option value="175">Maltese</option><option value="176">Manchester Terrier</option><option value="177">Maremma Sheepdog</option><option value="178">Markiesje</option><option value="179">Mastiff</option><option value="180">McNab</option><option value="181">Mexican Hairless</option><option value="182">Miniature Bull Terrier</option><option value="183">Miniature Pinscher</option><option value="184">Miniature Schnauzer</option><option value="185">Mountain Cur</option><option value="186">Mountain Dog</option><option value="187">Munsterlander</option><option value="188">Neapolitan Mastiff</option><option value="189">New Guinea Singing Dog</option><option value="190">Newfoundland Dog</option><option value="191">Norfolk Terrier</option><option value="192">Norwegian Buhund</option><option value="193">Norwegian Elkhound</option><option value="194">Norwegian Lundehund</option><option value="195">Norwich Terrier</option><option value="196">Nova Scotia Duck-Tolling Retriever</option><option value="197">Old English Sheepdog</option><option value="198">Otterhound</option><option value="199">Papillon</option><option value="200">Parson Russell Terrier</option><option value="201">Patterdale Terrier (Fell Terrier)</option><option value="202">Pekingese</option><option value="203">Pembroke Welsh Corgi</option><option value="204">Peruvian Inca Orchid</option><option value="205">Peruvian Inca Orchid</option><option value="206">Petit Basset Griffon Vendeen</option><option value="207">Pharaoh Hound</option><option value="208">Picardy Shepherd</option><option value="209">Pit Bull Terrier</option><option value="210">Plott Hound</option><option value="211">Podengo Portugueso</option><option value="212">Pointer</option><option value="213">Polish Lowland Sheepdog</option><option value="214">Pomeranian</option><option value="215">Poodle (Miniature)</option><option value="216">Poodle (Standard)</option><option value="217">Poodle (T-Cup)</option><option value="218">Poodle (Toy)</option><option value="219">Poodle (unknown type)</option><option value="220">Portuguese Water Dog</option><option value="221">Presa Canario</option><option value="222">Pug</option><option value="223">Puli</option><option value="224">Pumi</option><option value="225">Queensland Heeler</option><option value="226">Rat Terrier</option><option value="227">Red Heeler</option><option value="228">Redbone Coonhound</option><option value="229">Retriever</option><option value="230">Rhodesian Ridgeback</option><option value="231">Rottweiler</option><option value="232">Russian Wolfhound</option><option value="233">Saarlooswolfhond</option><option value="234">Saint Bernard</option><option value="235">Saluki</option><option value="236">Saluki Greyhound</option><option value="237">Samoyed</option><option value="238">Schiller Hound</option><option value="239">Schipperke</option><option value="240">Schnauzer</option><option value="241">Scottish Deerhound</option><option value="242">Scottish Terrier Scottie</option><option value="243">Sealyham Terrier</option><option value="244">Setter</option><option value="245">Shar Pei</option><option value="246">Sheep Dog</option><option value="247">Shepherd</option><option value="248">Shetland Sheepdog Sheltie</option><option value="249">Shiba Inu</option><option value="250">Shih Tzu</option><option value="251">Siberian Husky</option><option value="252">Silky Terrier</option><option value="253">Skye Terrier</option><option value="254">Sloughi</option><option value="255">Smooth Fox Terrier</option><option value="256">Soft-Coated Wheaten Terrier</option><option value="257">South Russian Ovcharka</option><option value="258">Spaniel</option><option value="259">Spanish Mastiff</option><option value="260">Spinone Italiano</option><option value="261">Spitz</option><option value="262">Springer Spaniel</option><option value="263">Staffordshire Bull Terrier</option><option value="264">Sussex Spaniel</option><option value="265">Swedish Vallhund</option><option value="266">Terrier</option><option value="267">Thai Ridgeback</option><option value="268">Tibetan Mastiff</option><option value="269">Tibetan Spaniel</option><option value="270">Tibetan Terrier</option><option value="271">Tosa Inu</option><option value="272">Toy Fox Terrier</option><option value="273">Toy Terrier</option><option value="274">Treeing Walker Coonhound</option><option value="275">Vizsla</option><option value="276">Weimaraner</option><option value="277">Welsh Corgi</option><option value="278">Welsh Springer Spaniel</option><option value="279">Welsh Terrier</option><option value="280">West Highland White Terrier Westie</option><option value="281">Wheaten Terrier</option><option value="282">Whippet</option><option value="283">White German Shepherd</option><option value="284">Wire-haired Pointing Griffon</option><option value="285">Wirehaired Fox Terrier</option><option value="286">Wolf Dog</option><option value="287">Xoloitzcuintle/Mexican Hairless</option><option value="288">Yellow Labrador Retriever</option><option value="289">Yorkshire Terrier Yorkie</option></select>
=end
  gender =
    case target_gender.downcase
    when 'male' then 1
    when 'female' then 2
    else raise "Unknown gender: #{target_gender}"
    end

  age_range =
    # TODO: add all ages
    case target_age.downcase
    when 'puppy' then 1
    else raise "Unknown age: #{target_age}"
    end

  ads = `wget -qO- 'https://www.allpaws.com/search/results?page=1&d=#{distance}&primary_breed_first=1&gender%5B%5D=#{gender}&age_range%5B%5D=#{age_range}&name=&organization_name=&sort=recency&utf8=%E2%9C%93&species_id=#{species_id}&breed_id=#{breed_id}&zip_code=#{target_zip}'`
  ads = JSON.parse(ads)["animals"]
  # TODO: fix time param; there is no date in the ad record?!
  time = Time.now
  notes = ["Date not accurate--not specified in results"]

  ads.reject! { |ad| target_exclude_breeds.any? { |b| !ad["breed"].upcase[b.upcase].nil? } }

  all_ads += ads.map { |ad| Adoptable::Ad.new(name, ad["id"], time -= 24 * 60 * 60, ad["card_avatar"], "https://www.allpaws.com#{ad["profile_path"]}", ad["location"], notes) }
 end

 all_ads
end
